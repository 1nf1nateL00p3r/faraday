import pytest
from server.models import Reference

def test_standard_host_vuln_hostnames(vulnerability_factory,
                                      host_with_hostnames,
                                      session):
    vuln = vulnerability_factory.create(host=host_with_hostnames,
                                        service=None)
    session.commit()
    assert set(vuln.hostnames) == set(host_with_hostnames.hostnames)

def test_standard_vuln_service_hostnames(vulnerability_factory,
                                         service_factory,
                                         host_with_hostnames,
                                         session):
    service = service_factory.create(host=host_with_hostnames)
    vuln = vulnerability_factory.create(service=service, host=None)
    session.commit()
    assert set(vuln.hostnames) == set(host_with_hostnames.hostnames)

def test_web_vuln_hostnames(vulnerability_web_factory,
                            service_factory,
                            host_with_hostnames,
                            session):
    service = service_factory.create(host=host_with_hostnames)
    vuln = vulnerability_web_factory.create(service=service)
    session.commit()
    assert set(vuln.hostnames) == set(host_with_hostnames.hostnames)

def test_code_vuln(vulnerability_code, session):
    session.commit()
    # Source code vulnerabilities have no hostnames
    assert vulnerability_code.hostnames == []


class TestReferences:
    @pytest.fixture(autouse=True)
    def load_data(self, vulnerability_factory, session):
        self.vuln = vulnerability_factory.create()
        self.vuln2 = vulnerability_factory.create(
            workspace=self.vuln.workspace)
        self.vuln_different_ws = vulnerability_factory.create()
        self.vulns = [self.vuln, self.vuln2, self.vuln_different_ws]
        session.commit()
        assert self.vuln.workspace_id != self.vuln_different_ws.workspace_id

    def test_empty_references(self):
        for vuln in self.vulns:
            assert isinstance(vuln.reference_instances, set)
            assert len(vuln.references) == 0

    def test_add_references(self, session):
        self.vuln.references.add('CVE-2017-1234')
        assert session.new
        session.commion()
        assert Reference.query.count() == 1
        ref = Reference.query.first()
        assert ref.name == 'CVE-2017-1234'
        assert ref.workspace_id == self.vuln.workspace_id
